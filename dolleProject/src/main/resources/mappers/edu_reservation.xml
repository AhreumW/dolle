<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.edu.reservation">

	<resultMap type="com.edu.reservation.vo.ReservationVo" id="reservationResultMap">
		<id column="RESERVE_IDX" property="reserveNo" />
		<result column="TOUR_IDX" property="tourNo" />
		<result column="TOUR_NAME" property="tourName" />
		<result column="MEMBER_IDX" property="memberNo" />
		<result column="MEMBER_NAME" property="memberName" />
		<result column="MEMBER_EMAIL" property="memberEmail" />
		<result column="MEMBER_AGE" property="memberAge" />
		<result column="RESERVE_TOUR_DATE" property="reserveTourDate" javaType="java.util.Date" />
		<result column="RESERVE_TOUR_DAY" property="reserveTourDay" />
		<result column="RESERVE_APPLY_NUM" property="reserveApplyNum" />
		<result column="RESERVE_APPLY_NUM_SUM" property="reserveApplyNumSum" />
		<result column="RESERVE_PRICE" property="reservePrice" />
		<result column="RESERVE_APPLY_DATE" property="reserveApplyDate" javaType="java.util.Date" />
		<result column="RESERVE_DEPOSIT_DATE" property="reserveDepositDate" javaType="java.util.Date" />
		<result column="RESERVE_DEPOSIT_STATE" property="reserveDepositState" />
	</resultMap>
	
	<resultMap type="com.edu.reservation.vo.TourVo" id="tourResultMap">
		<id column="TOUR_IDX" property="tourNo" />
		<result column="TOWN_IDX" property="townNo" />
		<result column="TOUR_NAME" property="tourName" />
		<result column="TOUR_START_DATE" property="tourStartDate" javaType="java.util.Date" />
		<result column="TOUR_END_DATE" property="tourEndDate" javaType="java.util.Date" />
		<result column="TOUR_CLOSED_START_DATE" property="tourClosedStartDate" javaType="java.util.Date" />
		<result column="TOUR_CLOSED_END_DATE" property="tourClosedEndDate" javaType="java.util.Date" />
		<result column="TOUR_START_TIME" property="tourStartTime" />
		<result column="TOUR_END_TIME" property="tourEndTime" />
		<result column="TOUR_PRICE" property="tourPrice" />
		<result column="TOUR_PEOPLE_NUM" property="tourPeopleNum" />
		<result column="TOUR_STARTING_POINT" property="tourStartingPoint" />
		<result column="TOUR_CONTENT" property="tourContent" />
		<result column="TOUR_CRE_DATE" property="tourCreDate" javaType="java.util.Date" />
		<result column="TOUR_MOD_DATE" property="tourModDate" javaType="java.util.Date" />
		<result column="TOUR_DEL_YN" property="tourDel" />
		<result column="TOUR_POSSIBLE_NUM" property="tourPossibleNum" />
		<result column="TOUR_RESERVED_NUM" property="tourReservedNum" />
		<result column="TOUR_ACCOUNT_NUM" property="tourAccountNum" />
	</resultMap>   
	
	<select id="tourSelectList" parameterType="map" resultMap="tourResultMap">
		SELECT TOUR_IDX, TOWN_IDX, TOUR_NAME, TOUR_START_DATE,
		TOUR_END_DATE, TOUR_START_TIME, TOUR_END_TIME, TOUR_PRICE,
		TOUR_PEOPLE_NUM, TOUR_STARTING_POINT, TOUR_CONTENT, TOUR_CRE_DATE,
		TOUR_MOD_DATE, TOUR_DEL_YN
		FROM TOUR
	</select>
	
	<select id="tourSelectOne" parameterType="int" resultMap="tourResultMap">
		SELECT TOUR_IDX, TOWN_IDX, TOUR_NAME, TOUR_START_DATE,
		TOUR_END_DATE, TOUR_START_TIME, TOUR_END_TIME, TOUR_PRICE,
		TOUR_PEOPLE_NUM, TOUR_STARTING_POINT, TOUR_CONTENT, TOUR_CRE_DATE,
		TOUR_MOD_DATE, TOUR_DEL_YN
		FROM TOUR
		WHERE TOUR_IDX = #{tourNo}	
	</select>
	
	<select id="tourSelectAllFromOne" parameterType="int" resultMap="tourResultMap">
		SELECT TOUR_IDX, TOWN_IDX, TOUR_NAME, TOUR_START_DATE, TOUR_END_DATE, 
        (SELECT CLOSED_START_DATE
        FROM CLOSED_DAY
        WHERE TOUR_IDX = #{tourNo}) AS TOUR_CLOSED_START_DATE,
        (SELECT CLOSED_END_DATE
        FROM CLOSED_DAY
        WHERE TOUR_IDX = #{tourNo}) AS TOUR_CLOSED_END_DATE,
        TOUR_START_TIME, TOUR_END_TIME, TOUR_PRICE,
		TOUR_PEOPLE_NUM, TOUR_STARTING_POINT, TOUR_CONTENT, TOUR_CRE_DATE,
		TOUR_MOD_DATE, TOUR_DEL_YN
		FROM TOUR
		WHERE TOUR_IDX = #{tourNo}
	</select>
	
	<select id="tourAndReservationSelectAllFromOne" parameterType="map" resultMap="tourResultMap">
	SELECT T.TOUR_IDX AS TOUR_IDX, TOWN_IDX, TOUR_NAME, TOUR_START_DATE, TOUR_END_DATE, 
    C.CLOSED_START_DATE AS TOUR_CLOSED_START_DATE,
    C.CLOSED_END_DATE AS TOUR_CLOSED_END_DATE,
    (SELECT SUM(R.RESERVE_APPLY_NUM)
    FROM RESERVE R, TOUR T
    WHERE R.TOUR_IDX = T.TOUR_IDX
    AND R.RESERVE_TOUR_DATE = #{reserveTourDate}
    AND R.RESERVE_DEPOSIT_STATE = 'active'
    GROUP BY R.TOUR_IDX
    HAVING R.TOUR_IDX = #{tourNo}) as TOUR_RESERVED_NUM,
    (T.TOUR_PEOPLE_NUM - (SELECT SUM(R.RESERVE_APPLY_NUM)
    FROM RESERVE R, TOUR T
    WHERE R.TOUR_IDX = T.TOUR_IDX
    AND R.RESERVE_TOUR_DATE = #{reserveTourDate}
    AND R.RESERVE_DEPOSIT_STATE = 'active'
    GROUP BY R.TOUR_IDX
    HAVING R.TOUR_IDX = #{tourNo})) AS TOUR_POSSIBLE_NUM,
    (SELECT A1.ACC_ACCOUNT_NUM
    FROM TOUR T1, ACCOUNT_MANAGEMENT A1
    WHERE T1.TOWN_IDX = A1.TOWN_IDX
    AND T1.TOUR_IDX = #{tourNo}) AS TOUR_ACCOUNT_NUM,
    
    TOUR_START_TIME, TOUR_END_TIME, TOUR_PRICE,
	TOUR_PEOPLE_NUM, TOUR_STARTING_POINT, TOUR_CONTENT, TOUR_CRE_DATE,
	TOUR_MOD_DATE, TOUR_DEL_YN
    
    FROM TOUR T, CLOSED_DAY C
    WHERE C.TOUR_IDX = T.TOUR_IDX
    AND T.TOUR_IDX = #{tourNo}
	</select>
	
	<insert id="tourReservationInsertOne" parameterType="map">
		INSERT INTO RESERVE
		(RESERVE_IDX, TOUR_IDX, MEMBER_IDX,       
		RESERVE_TOUR_DATE, RESERVE_APPLY_NUM, RESERVE_PRICE, RESERVE_APPLY_DATE,
		RESERVE_DEPOSIT_DATE)
		VALUES
		(SEQ_RESERVE_NO.NEXTVAL, #{tourNo}, #{memberNo},
		#{reserveTourDate}, #{reserveApplyNum}, #{reservePrice}, SYSDATE,
		NULL)
	</insert>
	
	<select id="reservationSelectNewestOne" parameterType="map" resultMap="reservationResultMap">
		SELECT RESERVE_IDX, TOUR_IDX, MEMBER_IDX,       
		RESERVE_TOUR_DATE, RESERVE_APPLY_NUM, RESERVE_PRICE, RESERVE_APPLY_DATE,
		RESERVE_DEPOSIT_DATE, RESERVE_DEPOSIT_STATE
		FROM RESERVE
		WHERE RESERVE_IDX = (SELECT MAX(RESERVE_IDX)
							FROM RESERVE)
	</select>
	
	<select id="tourReservationSelectList" parameterType="map" resultMap="reservationResultMap">
		SELECT RESERVE_TOUR_DATE, (SELECT TOUR_NAME
									FROM TOUR
									WHERE TOUR_IDX = 1) AS TOUR_NAME,
		TO_CHAR(RESERVE_TOUR_DATE, 'DY') AS RESERVE_TOUR_DAY, SUM(RESERVE_APPLY_NUM) AS RESERVE_APPLY_NUM_SUM
		FROM RESERVE
		WHERE RESERVE_DEPOSIT_STATE = 'active'
		AND TOUR_IDX = 1
		AND RESERVE_TOUR_DATE BETWEEN '20200701' AND '20200731'
		GROUP BY RESERVE_TOUR_DATE
        ORDER BY RESERVE_TOUR_DATE ASC
	</select>
	
	<select id="tourReservationSelectListAll" parameterType="map" resultMap="reservationResultMap">
		SELECT R.RESERVE_IDX, M.MEMBER_NAME AS MEMBER_NAME, M.MEMBER_EMAIL AS MEMBER_EMAIL, 
		TRUNC(MONTHS_BETWEEN(TRUNC(SYSDATE), M.MEMBER_BIRTHDATE) / 12) AS MEMBER_AGE, 
		R.TOUR_IDX, R.RESERVE_TOUR_DATE, R.RESERVE_APPLY_NUM, R.RESERVE_DEPOSIT_STATE, R.RESERVE_DEPOSIT_DATE
		FROM RESERVE R, MEMBER M
		WHERE R.MEMBER_IDX = M.MEMBER_IDX
	</select>

	<update id="tourUpdateOne" parameterType="map">
		UPDATE TOUR
		SET
		TOUR_NAME = #{tourName}, TOUR_START_DATE = #{tourStartDate},  TOUR_END_DATE = #{tourEndDate}, 
		TOUR_START_TIME = #{tourStartTime},  TOUR_END_TIME = #{tourEndTime},
		TOUR_PEOPLE_NUM = #{tourPeopleNum},
		TOUR_PRICE = #{tourPrice},
		TOUR_STARTING_POINT = #{tourStartingPoint},
		TOUR_CONTENT = #{tourContent},
		TOUR_MOD_DATE = SYSDATE
		WHERE TOUR_IDX = #{tourNo}
	</update>
	
	<delete id="tourDeleteOne" parameterType="int">
		DELETE FROM TOUR
		WHERE TOUR_IDX = #{tourNo}
	</delete>
	
</mapper>