<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.edu.courseReview">

	<resultMap type="com.edu.courseReview.vo.CourseReviewVo" 
		id="courseReivewMap">
		<id column="REVIEW_IDX" property="reviewIdx"/>
		<result column="MEMBER_IDX" property="reviewMemberIdx"/>
		<result column="COURSE_IDX" property="reviewCourseIdx"/>
		<result column="REVIEW_TITLE" property="reviewTitle"/>
		<result column="REVIEW_CONTENT" property="reviewContent"/>
		<result column="REVIEW_READ_COUNT" property="reviewReadCount"/>
		<result column="REVIEW_LIKE_COUNT" property="reviewLikeCount"/>
		<result column="REVIEW_RATING" property="reviewRating"/>
		<result column="REVIEW_DEL_YN" property="reviewDelYn"/>
		<result column="REVIEW_CRE_DATE" property="reviewCreDate"
			javaType="java.util.Date"/>
		<result column="REVIEW_MOD_DATE" property="reviewModDate"
			javaType="java.util.Date"/>
	</resultMap>

	<resultMap type="com.edu.courseReview.vo.CourseReviewMemberCommentFileVo"  
		id="courseReviewMemberCommentFileMap">
		<id column="REVIEW_IDX" property="reviewIdx"/>
		<result column="MEMBER_IDX_R" property="reviewMemberIdx"/>
		<result column="COURSE_IDX_R" property="reviewCourseIdx"/>
		<result column="REVIEW_TITLE" property="reviewTitle"/>
		<result column="REVIEW_CONTENT" property="reviewContent"/>
		<result column="REVIEW_READ_COUNT" property="reviewReadCount"/>
		<result column="REVIEW_LIKE_COUNT" property="reviewLikeCount"/>
		<result column="REVIEW_RATING" property="reviewRating"/>
		<result column="REVIEW_DEL_YN" property="reviewDelYn"/>
		<result column="REVIEW_CRE_DATE" property="reviewCreDate"
			javaType="java.util.Date"/>
		<result column="REVIEW_MOD_DATE" property="reviewModDate"
			javaType="java.util.Date"/>
		
		<result column="MEMBER_IDX" property="memberIdx"/>
		<result column="MEMBER_EMAIL" property="memberEmail"/>
		<result column="MEMBER_NICKNAME" property="memberNickname"/>
		
		<result column="COMMENT_IDX" property="commentIdx"/>
		<result column="REVIEW_IDX_C" property="commentReviewIdx"/>
		<result column="MEMBER_IDX_C" property="commentMemberIdx"/>
		<result column="COMMENT_CONTENT" property="commentContent"/>
		<result column="COMMENT_COUNT" property="commentCount"/>
		<result column="COMMENT_DEL_YN" property="commentDelYn"/>
		
		<result column="REVIEW_FILE_IDX" property="fileIdx"/>
		<result column="REVIEW_IDX_F" property="fileReviewIdx"/>
		<result column="REVIEW_ORIGINAL_FILE_NAME" property="fileOriginalName"/>
		<result column="REVIEW_STORED_FILE_NAME" property="fileStoredName"/>
	</resultMap> 

	<select id="reviewSelectList" parameterType="map" resultMap="courseReivewMap">
		SELECT REVIEW_IDX, REVIEW_TITLE 
		FROM REVIEWBOARD
	</select>

	<select id="reviewMemComFileList" parameterType="map" resultMap="courseReviewMemberCommentFileMap">
		SELECT RB.REVIEW_IDX, REVIEW_TITLE, M.MEMBER_NICKNAME, REVIEW_RATING, REVIEW_LIKE_COUNT, C.COMMENT_COUNT, RF.REVIEW_STORED_FILE_NAME
		FROM REVIEWBOARD RB, MEMBER M
		    ,(SELECT REVIEW_IDX, COUNT(*) AS COMMENT_COUNT FROM REVIEW_COMMENT GROUP BY REVIEW_IDX) C
		    ,(SELECT REVIEW_IDX, REVIEW_STORED_FILE_NAME FROM REVIEW_FILE) RF
		WHERE RB.MEMBER_IDX = M.MEMBER_IDX
		AND RB.REVIEW_IDX = C.REVIEW_IDX(+)
		AND RB.REVIEW_IDX = RF.REVIEW_IDX(+)
		ORDER BY RB.REVIEW_IDX DESC
	</select> 
	
	
	<insert id="reviewInsertOne" parameterType="CourseReviewVo">
		INSERT INTO REVIEWBOARD
		(REVIEW_IDX, MEMBER_IDX, COURSE_IDX, REVIEW_TITLE, REVIEW_CONTENT, REVIEW_RATING)
		VALUES(SEQ_REVIEW_NO.NEXTVAL, #{reviewMemberIdx}, 1, #{reviewTitle}, #{reviewContent}, #{reviewRating})
	</insert>
	
	<insert id="fileInsertOne" parameterType="map">
		INSERT INTO REVIEW_FILE
		(REVIEW_FILE_IDX, REVIEW_IDX, REVIEW_ORIGINAL_FILE_NAME, REVIEW_STORED_FILE_NAME, REVIEW_FILE_SIZE)
		VALUES(SEQ_REVIEW_FILE_NO.NEXTVAL, #{review_idx}, #{review_original_file_name},
			 #{review_stored_file_name}, #{review_file_size})
	</insert>
	<!-- 파일 insert시 사용 -->
	<select id="reviewNewestSelectIdx" resultType="int">
		SELECT REVIEW_IDX 
		FROM (SELECT ROWNUM, REVIEW_IDX
				FROM REVIEWBOARD
				ORDER BY REVIEW_IDX DESC)
		WHERE ROWNUM = 1
	</select>
	
	
	<select id="reviewSelectOne" parameterType="int" 
		resultMap="courseReviewMemberCommentFileMap">
		SELECT RB.REVIEW_IDX, M.MEMBER_NICKNAME, RB.REVIEW_TITLE, RB.REVIEW_CONTENT, RB.REVIEW_RATING, RB.REVIEW_LIKE_COUNT
			, RB.REVIEW_READ_COUNT, RF.REVIEW_STORED_FILE_NAME, RB.REVIEW_CRE_DATE, RB.REVIEW_MOD_DATE
		FROM REVIEWBOARD RB, MEMBER M	
		    ,(SELECT REVIEW_IDX, COUNT(*) AS COMMENT_COUNT FROM REVIEW_COMMENT GROUP BY REVIEW_IDX) C
		    ,(SELECT REVIEW_IDX, REVIEW_STORED_FILE_NAME FROM REVIEW_FILE) RF
		WHERE RB.MEMBER_IDX = M.MEMBER_IDX
		AND RB.REVIEW_IDX = C.REVIEW_IDX(+)
		AND RB.REVIEW_IDX = RF.REVIEW_IDX(+)
		AND RB.REVIEW_IDX = #{review_idx}
	</select>
	
	
	<update id="reviewUpdateOne" parameterType="CourseReviewVo">
		UPDATE REVIEWBOARD
		SET REVIEW_TITLE = #{reviewTitle}, REVIEW_CONTENT = #{reviewContent}
		, REVIEW_RATING = #{reviewRating}, REVIEW_MOD_DATE = SYSDATE
		WHERE REVIEW_IDX = #{reviewIdx}
	</update>
	
	<update id="fileUpdateOne" parameterType="map">
		UPDATE REVIEW_FILE
		SET REVIEW_ORIGINAL_FILE_NAME = #{review_original_file_name}
		, REVIEW_STORED_FILE_NAME = #{review_stored_file_name}
		, REVIEW_FILE_SIZE = #{review_file_size}
		WHERE REVIEW_IDX = #{review_idx}
	</update>
	
	<select id="fileSelectStoredName" parameterType="int"
		resultType="map">
		SELECT REVIEW_FILE_IDX, REVIEW_STORED_FILE_NAME
		FROM REVIEW_FILE
		WHERE REVIEW_IDX = #{review_idx}
	</select>
	
	
	<delete id="reviewDeleteOne" parameterType="int">
		DELETE FROM REVIEWBOARD
		WHERE REVIEW_IDX = #{review_idx}
	</delete>
	
	<delete id="fileDeleteOne" parameterType="int">
		DELETE FROM REVIEW_FILE
		WHERE REVIEW_IDX = #{review_idx}
	</delete>
	
</mapper>